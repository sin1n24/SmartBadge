<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>XIAO Attitude Controller</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: sans-serif; text-align: center; padding: 20px; background: #f0f4f8; }
        .container { max-width: 900px; margin: 0 auto; background: white; padding: 20px; border-radius: 12px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .controls { margin: 20px 0; display: flex; justify-content: center; gap: 10px; align-items: center; }
        button { padding: 12px 20px; cursor: pointer; border: none; border-radius: 6px; color: white; font-size: 1em; transition: 0.2s; }
        button:hover { opacity: 0.8; }
        button:disabled { background: #cfd8dc !important; cursor: not-allowed; }
        
        #btnConnect { background: #2196F3; }
        #btnRed { background: #F44336; }
        #btnBlue { background: #2196F3; }
        #btnOff { background: #607D8B; }
        #btnCalib { background: #FF9800; font-weight: bold; } /* オレンジ色 */

        #timer { font-size: 1.5em; font-weight: bold; color: #37474f; margin: 10px 0; }
        
        .val-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-bottom: 15px; }
        .val-card { background: #fafafa; padding: 10px; border-radius: 8px; border: 1px solid #eee; }
        .val-label { display: block; font-size: 0.9em; color: #666; margin-bottom: 5px; }
        .val-num { font-family: monospace; font-size: 1.4em; font-weight: bold; }
        
        #debug-log { text-align: left; font-family: monospace; font-size: 0.8em; color: #78909c; background: #eceff1; padding: 10px; margin-top: 20px; height: 80px; overflow-y: scroll; border-radius: 4px; }
    </style>
</head>
<body>

<div class="container">
    <h2>XIAO 姿勢角 & キャリブレーション</h2>
    
    <div id="timer">00:00:00</div>
    
    <div class="controls">
        <button id="btnConnect">接続開始</button>
        <div style="border-left: 1px solid #ccc; height: 30px; margin: 0 10px;"></div>
        <button id="btnRed" disabled>赤</button>
        <button id="btnBlue" disabled>青</button>
        <button id="btnOff" disabled>消灯</button>
        <button id="btnCalib" disabled>校正 (Calibrate)</button>
    </div>

    <div class="val-grid">
        <div class="val-card" style="border-bottom: 3px solid rgb(255, 99, 132)">
            <span class="val-label">Roll (回転)</span>
            <span id="valRoll" class="val-num" style="color:rgb(255, 99, 132)">0.00</span>°
        </div>
        <div class="val-card" style="border-bottom: 3px solid rgb(54, 162, 235)">
            <span class="val-label">Pitch (前後)</span>
            <span id="valPitch" class="val-num" style="color:rgb(54, 162, 235)">0.00</span>°
        </div>
        <div class="val-card" style="border-bottom: 3px solid rgb(75, 192, 192)">
            <span class="val-label">Yaw (方位)</span>
            <span id="valYaw" class="val-num" style="color:rgb(75, 192, 192)">0.00</span>°
        </div>
    </div>

    <canvas id="angleChart"></canvas>
    <div id="debug-log">準備完了</div>
</div>

<script>
    const SERVICE_UUID   = '12345678-1234-5678-1234-56789abcdef0';
    const CHAR_ANGLE_UUID = '12345678-1234-5678-1234-56789abcdef1';
    const CHAR_LED_UUID  = '12345678-1234-5678-1234-56789abcdef2';

    let bluetoothDevice;
    let ledCharacteristic;
    let startTime;
    let timerInterval = null; // タイマーID
    let chart;

    const maxPoints = 100;
    const labelsData = new Array(maxPoints).fill('');
    const rollData   = new Array(maxPoints).fill(0);
    const pitchData  = new Array(maxPoints).fill(0);
    const yawData    = new Array(maxPoints).fill(0);

    function log(msg) {
        const logBox = document.getElementById('debug-log');
        const ts = new Date().toLocaleTimeString();
        logBox.innerHTML = `[${ts}] ${msg}<br>` + logBox.innerHTML.slice(0, 1000);
        console.log(msg);
    }

    function initChart() {
        const ctx = document.getElementById('angleChart').getContext('2d');
        chart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labelsData,
                datasets: [
                    { label: 'Roll', data: rollData, borderColor: 'rgb(255, 99, 132)', borderWidth: 2, pointRadius: 0 },
                    { label: 'Pitch', data: pitchData, borderColor: 'rgb(54, 162, 235)', borderWidth: 2, pointRadius: 0 },
                    { label: 'Yaw', data: yawData, borderColor: 'rgb(75, 192, 192)', borderWidth: 2, pointRadius: 0 }
                ]
            },
            options: {
                responsive: true,
                animation: false,
                interaction: { intersect: false },
                scales: {
                    y: { 
                        min: -180, max: 180, // Y軸固定
                        ticks: { stepSize: 45 }
                    }
                }
            }
        });
    }

    document.getElementById('btnConnect').addEventListener('click', async () => {
        try {
            if (!chart) initChart();

            bluetoothDevice = await navigator.bluetooth.requestDevice({
                filters: [{ namePrefix: "XIAO" }],
                optionalServices: [SERVICE_UUID]
            });

            bluetoothDevice.addEventListener('gattserverdisconnected', onDisconnected);

            log("接続中: " + bluetoothDevice.name);
            const server = await bluetoothDevice.gatt.connect();
            const service = await server.getPrimaryService(SERVICE_UUID);
            
            ledCharacteristic = await service.getCharacteristic(CHAR_LED_UUID);
            
            const angleChar = await service.getCharacteristic(CHAR_ANGLE_UUID);
            await angleChar.startNotifications();
            angleChar.addEventListener('characteristicvaluechanged', handleAngleData);

            // UI更新
            document.getElementById('btnConnect').disabled = true;
            document.getElementById('btnConnect').textContent = "接続済み";
            document.querySelectorAll('button:disabled').forEach(b => b.disabled = false);

            // タイマー開始 (リセットしてから)
            if (timerInterval) clearInterval(timerInterval);
            startTime = Date.now();
            updateTimer(); // 00:00:00即時表示
            timerInterval = setInterval(updateTimer, 100);
            
            log("通信開始");

        } catch (e) {
            log("接続エラー: " + e);
        }
    });

    function onDisconnected(event) {
        log("切断されました");
        document.getElementById('btnConnect').disabled = false;
        document.getElementById('btnConnect').textContent = "再接続";
        document.querySelectorAll('button:not(#btnConnect)').forEach(b => b.disabled = true);
        
        // ★重要: 切断時にタイマーを止める
        if (timerInterval) {
            clearInterval(timerInterval);
            timerInterval = null;
        }
    }

    function handleAngleData(event) {
        const value = event.target.value;
        const roll = value.getFloat32(0, true);
        const pitch = value.getFloat32(4, true);
        const yaw = value.getFloat32(8, true);

        document.getElementById('valRoll').textContent = roll.toFixed(1);
        document.getElementById('valPitch').textContent = pitch.toFixed(1);
        document.getElementById('valYaw').textContent = yaw.toFixed(1);

        labelsData.shift(); labelsData.push('');
        rollData.shift();   rollData.push(roll);
        pitchData.shift();  pitchData.push(pitch);
        yawData.shift();    yawData.push(yaw);

        chart.update('none');
    }

    function updateTimer() {
        const diff = Date.now() - startTime;
        const d = new Date(diff);
        const m = String(d.getUTCMinutes()).padStart(2, '0');
        const s = String(d.getUTCSeconds()).padStart(2, '0');
        const ms = String(Math.floor(d.getUTCMilliseconds()/100)).padStart(1, '0');
        document.getElementById('timer').textContent = `${m}:${s}.${ms}`;
    }

    async function sendLed(cmd) {
        if (ledCharacteristic) {
            try {
                await ledCharacteristic.writeValue(new Uint8Array([cmd]));
                if(cmd === 3) log("キャリブレーションコマンド送信");
            } catch(e) { log("送信エラー: " + e); }
        }
    }
    
    document.getElementById('btnRed').onclick = () => sendLed(1);
    document.getElementById('btnBlue').onclick = () => sendLed(2);
    document.getElementById('btnOff').onclick = () => sendLed(0);
    
    // ★重要: キャリブレーションボタン (コマンド 3)
    document.getElementById('btnCalib').onclick = () => {
        log("静止してください...");
        sendLed(3);
    };

    initChart();
</script>
</body>
</html>
