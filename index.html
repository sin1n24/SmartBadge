<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>XIAO Data Receiver</title>
    <style>
        body { font-family: monospace; text-align: center; padding: 20px; font-size: 1.2em; }
        .val { color: blue; font-weight: bold; }
        button { padding: 10px 20px; font-size: 1em; }
    </style>
</head>
<body>
    <h2>XIAO データ受信 (0xFFFF)</h2>
    <button id="btnScan">スキャン開始</button>
    <div id="status" style="margin: 15px; color: #666;">待機中...</div>
    <hr>
    <div>
        RSSI: <span id="rssi">--</span> dBm <br>
        Count: <span id="cnt">0</span>
    </div>
    <div style="margin-top: 20px; text-align: left; display: inline-block;">
        Gyro X: <span id="gx" class="val">0.00</span> <br>
        Gyro Y: <span id="gy" class="val">0.00</span> <br>
        Gyro Z: <span id="gz" class="val">0.00</span>
    </div>

    <script>
        const btnScan = document.getElementById('btnScan');
        const TEST_ID = 0xFFFF; // 今回使用するID

        btnScan.addEventListener('click', async () => {
            try {
                document.getElementById('status').textContent = "デバイスを選択してください...";

                // 1. 0xFFFF のデータを持つデバイスを探す
                const device = await navigator.bluetooth.requestDevice({
                    filters: [{ namePrefix: "XIAO" }],
                    optionalManufacturerData: [TEST_ID]
                });

                document.getElementById('status').textContent = "受信中: " + device.name;
                
                // 2. 監視開始
                await device.watchAdvertisements();

                // 3. データ受信イベント
                device.addEventListener('advertisementreceived', (event) => {
                    document.getElementById('rssi').textContent = event.rssi;
                    document.getElementById('cnt').textContent = parseInt(document.getElementById('cnt').textContent) + 1;

                    // Manufacturer Data (0xFFFF) を取得
                    // ブラウザは自動的にCompany ID (最初の2バイト) をキーとして解釈します
                    const data = event.manufacturerData.get(TEST_ID);
                    
                    if (data) {
                        // データ長さチェック (今回は3軸 x 2byte = 6byte)
                        // ※ C++側では8byte送りましたが、CompanyID(2byte)はキーになるため、
                        //    ここ(value)には残りの6byteが入ってきます。
                        if (data.byteLength >= 6) {
                            // リトルエンディアンで読み取り、100で割る
                            const x = data.getInt16(0, true) / 100.0;
                            const y = data.getInt16(2, true) / 100.0;
                            const z = data.getInt16(4, true) / 100.0;

                            document.getElementById('gx').textContent = x.toFixed(2);
                            document.getElementById('gy').textContent = y.toFixed(2);
                            document.getElementById('gz').textContent = z.toFixed(2);
                        }
                    }
                });

            } catch (error) {
                console.error(error);
                document.getElementById('status').textContent = "エラー: " + error;
            }
        });
    </script>
</body>
</html>
