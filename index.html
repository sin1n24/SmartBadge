<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>XIAO Beacon Test</title>
</head>
<body>
    <h2>XIAO ビーコン受信テスト</h2>
    <p>XIAOが発信しているビーコン信号を表示します。</p>
    <button id="btnScan">スキャン開始</button>
    <div id="status">待機中...</div>
    <hr>
    <div id="output" style="font-family: monospace; font-size: 1.2em;">
        <div>デバイス名: <span id="devName">--</span></div>
        <div>RSSI (強度): <span id="rssi" style="color:red;">--</span> dBm</div>
        <div>Company ID: <span id="compId">--</span></div>
        <div>データ(Hex): <span id="hexData" style="color:blue;">--</span></div>
    </div>

    <script>
        const btnScan = document.getElementById('btnScan');
        const status = document.getElementById('status');

        btnScan.addEventListener('click', async () => {
            try {
                status.textContent = "デバイスを選択してください...";

                // 1. デバイスを検索
                // namePrefix: "XIAO" で始まるデバイスを探します
                // optionalManufacturerData: 0x004C (Apple/iBeacon) と 0xFFFF (テスト用) の閲覧を許可
                const device = await navigator.bluetooth.requestDevice({
                    filters: [{ namePrefix: "XIAO" }],
                    optionalManufacturerData: [0x004C, 0xFFFF]
                });

                status.textContent = "ビーコン受信中: " + device.name;
                document.getElementById('devName').textContent = device.name;

                // 2. アドバタイズパケット（ビーコン信号）の監視を開始
                await device.watchAdvertisements();

                // 3. 信号を受信するたびに実行される処理
                device.addEventListener('advertisementreceived', (event) => {
                    // RSSI（電波強度）の更新
                    document.getElementById('rssi').textContent = event.rssi;

                    // Manufacturer Data (企業IDとデータ) の取得
                    const manufacturerData = event.manufacturerData;
                    
                    // データの中身を表示
                    manufacturerData.forEach((value, key) => {
                        // Company ID (例: 0x004c)
                        document.getElementById('compId').textContent = "0x" + key.toString(16).toUpperCase().padStart(4, '0');
                        
                        // データ部 (Byte配列) を16進数文字列に変換
                        let hexString = "";
                        for (let i = 0; i < value.byteLength; i++) {
                            hexString += value.getUint8(i).toString(16).toUpperCase().padStart(2, '0') + " ";
                        }
                        document.getElementById('hexData').textContent = hexString;
                    });
                });

            } catch (error) {
                console.error(error);
                status.textContent = "エラー: " + error;
            }
        });
    </script>
</body>
</html>
