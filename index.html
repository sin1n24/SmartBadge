<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>XIAO Gyro Graph & Control</title>
    <!-- Chart.js ライブラリの読み込み -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: sans-serif; text-align: center; padding: 20px; background-color: #f8f9fa; }
        .container { max-width: 800px; margin: 0 auto; background: white; padding: 20px; border-radius: 10px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
        .btn-group { margin: 20px 0; }
        button { padding: 10px 20px; font-size: 16px; margin: 0 5px; cursor: pointer; border: none; border-radius: 5px; color: white; }
        #btnConnect { background-color: #28a745; }
        #btnRed { background-color: #dc3545; }
        #btnBlue { background-color: #007bff; }
        #btnOff { background-color: #6c757d; }
        .val-box { display: flex; justify-content: space-around; margin: 10px 0; font-size: 1.2em; font-family: monospace; }
        #timeDisplay { font-size: 1.5em; font-weight: bold; color: #333; margin-bottom: 10px;}
    </style>
</head>
<body>

<div class="container">
    <h2>XIAO Gyro Scope</h2>
    
    <div id="timeDisplay">00:00:00</div>
    
    <div class="btn-group">
        <button id="btnConnect">接続 (Connect)</button>
    </div>
    
    <div class="btn-group">
        <span>LED操作: </span>
        <button id="btnRed" disabled>赤 (Red)</button>
        <button id="btnBlue" disabled>青 (Blue)</button>
        <button id="btnOff" disabled>消灯 (Off)</button>
    </div>

    <div class="val-box">
        <span style="color:red">X: <span id="valX">0.00</span></span>
        <span style="color:blue">Y: <span id="valY">0.00</span></span>
        <span style="color:green">Z: <span id="valZ">0.00</span></span>
    </div>

    <canvas id="gyroChart"></canvas>
</div>

<script>
    // --- 定数・変数 ---
    const SERVICE_UUID   = '12345678-1234-5678-1234-56789abcdef0';
    const CHAR_GYRO_UUID = '12345678-1234-5678-1234-56789abcdef1';
    const CHAR_LED_UUID  = '12345678-1234-5678-1234-56789abcdef2';

    let device, ledChar;
    let startTime = 0;
    let timerInterval;
    
    // 受信データを一時的に溜めるキュー (バッファ)
    let dataQueue = []; 

    // --- グラフ初期化 (Chart.js) ---
    const ctx = document.getElementById('gyroChart').getContext('2d');
    const chart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: Array(50).fill(''), // 横軸50点分
            datasets: [
                { label: 'X', data: Array(50).fill(0), borderColor: 'red', borderWidth: 1, pointRadius: 0 },
                { label: 'Y', data: Array(50).fill(0), borderColor: 'blue', borderWidth: 1, pointRadius: 0 },
                { label: 'Z', data: Array(50).fill(0), borderColor: 'green', borderWidth: 1, pointRadius: 0 }
            ]
        },
        options: {
            animation: false, // 高速描画のためアニメーションOFF
            scales: { y: { min: -200, max: 200 } }
        }
    });

    // --- 接続処理 ---
    document.getElementById('btnConnect').addEventListener('click', async () => {
        try {
            device = await navigator.bluetooth.requestDevice({
                filters: [{ namePrefix: "XIAO" }],
                optionalServices: [SERVICE_UUID]
            });

            const server = await device.gatt.connect();
            const service = await server.getPrimaryService(SERVICE_UUID);
            
            // LED制御用の特性を取得
            ledChar = await service.getCharacteristic(CHAR_LED_UUID);
            
            // ジャイロ通知用の特性を取得
            const gyroChar = await service.getCharacteristic(CHAR_GYRO_UUID);
            await gyroChar.startNotifications();
            gyroChar.addEventListener('characteristicvaluechanged', handleGyroData);

            // UI更新
            startTime = Date.now();
            timerInterval = setInterval(updateTime, 100); // 時計更新
            setInterval(processQueue, 100); // 100msごとにデータをグラフへ反映
            
            document.getElementById('btnConnect').textContent = "接続済み";
            document.getElementById('btnConnect').disabled = true;
            document.querySelectorAll('button:not(#btnConnect)').forEach(b => b.disabled = false);

        } catch (e) {
            console.error(e);
            alert("接続エラー: " + e);
        }
    });

    // --- データ受信処理 (0.5秒に1回、5個まとめて来る) ---
    function handleGyroData(event) {
        const view = event.target.value;
        // 60バイト = float(4byte) * 3軸 * 5回分
        for (let i = 0; i < 5; i++) {
            const offset = i * 12; // 3float = 12byte
            const x = view.getFloat32(offset + 0, true);
            const y = view.getFloat32(offset + 4, true);
            const z = view.getFloat32(offset + 8, true);
            
            // キューに追加
            dataQueue.push({x, y, z});
        }
    }

    // --- データ表示処理 (100msごとに実行) ---
    function processQueue() {
        if (dataQueue.length > 0) {
            // キューから1つ取り出す (FIFO)
            const d = dataQueue.shift();

            // 数値表示更新
            document.getElementById('valX').textContent = d.x.toFixed(2);
            document.getElementById('valY').textContent = d.y.toFixed(2);
            document.getElementById('valZ').textContent = d.z.toFixed(2);

            // グラフ更新
            updateChart(chart, d);
        }
    }

    function updateChart(chart, data) {
        // 古いデータを削除して新しいデータを追加
        chart.data.datasets.data.shift();
        chart.data.datasets.data.push(data.x);
        chart.data.datasets[4].data.shift();
        chart.data.datasets[4].data.push(data.y);
        chart.data.datasets[5].data.shift();
        chart.data.datasets[5].data.push(data.z);
        chart.update();
    }

    // --- 時計更新 ---
    function updateTime() {
        const diff = Date.now() - startTime;
        const date = new Date(diff);
        const mm = String(date.getUTCMinutes()).padStart(2, '0');
        const ss = String(date.getUTCSeconds()).padStart(2, '0');
        const ms = String(Math.floor(date.getUTCMilliseconds()/100)).padStart(1, '0'); // 1/10秒
        document.getElementById('timeDisplay').textContent = `${mm}:${ss}.${ms}`;
    }

    // --- LEDボタン処理 ---
    async function sendLedCommand(cmd) {
        if (!ledChar) return;
        try {
            await ledChar.writeValue(new Uint8Array([cmd]));
        } catch(e) { console.error(e); }
    }

    document.getElementById('btnRed').onclick = () => sendLedCommand(1);
    document.getElementById('btnBlue').onclick = () => sendLedCommand(2);
    document.getElementById('btnOff').onclick = () => sendLedCommand(0);

</script>
</body>
</html>
