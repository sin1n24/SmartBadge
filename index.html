<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>XIAO Simple Graph</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: sans-serif; text-align: center; padding: 20px; }
        .container { max-width: 800px; margin: 0 auto; }
        button { padding: 10px 20px; font-size: 1.2em; cursor: pointer; background-color: #007bff; color: white; border: none; border-radius: 5px; }
        #status { margin: 10px; color: #666; }
    </style>
</head>
<body>

<div class="container">
    <h2>XIAO Gyro リアルタイムグラフ</h2>
    <button id="btnConnect">接続する</button>
    <div id="status">未接続</div>
    <div id="values">X: 0.00, Y: 0.00, Z: 0.00</div>
    <canvas id="gyroChart"></canvas>
</div>

<script>
    const SERVICE_UUID   = '12345678-1234-5678-1234-56789abcdef0';
    const CHAR_GYRO_UUID = '12345678-1234-5678-1234-56789abcdef1';

    // グラフ初期化
    const ctx = document.getElementById('gyroChart').getContext('2d');
    const maxDataPoints = 100; // 横軸のデータ数
    const chart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: Array(maxDataPoints).fill(''),
            datasets: [
                { label: 'X', data: Array(maxDataPoints).fill(0), borderColor: 'red', borderWidth: 1, pointRadius: 0 },
                { label: 'Y', data: Array(maxDataPoints).fill(0), borderColor: 'blue', borderWidth: 1, pointRadius: 0 },
                { label: 'Z', data: Array(maxDataPoints).fill(0), borderColor: 'green', borderWidth: 1, pointRadius: 0 }
            ]
        },
        options: {
            animation: false,
            scales: { y: { min: -250, max: 250 } }
        }
    });

    document.getElementById('btnConnect').addEventListener('click', async () => {
        try {
            const device = await navigator.bluetooth.requestDevice({
                filters: [{ namePrefix: "XIAO" }],
                optionalServices: [SERVICE_UUID]
            });

            document.getElementById('status').textContent = "接続中...";
            const server = await device.gatt.connect();
            const service = await server.getPrimaryService(SERVICE_UUID);
            const characteristic = await service.getCharacteristic(CHAR_GYRO_UUID);

            await characteristic.startNotifications();
            characteristic.addEventListener('characteristicvaluechanged', handleData);

            document.getElementById('status').textContent = "受信中: " + device.name;
            document.getElementById('btnConnect').disabled = true;

        } catch (error) {
            console.error(error);
            document.getElementById('status').textContent = "エラー: " + error;
        }
    });

    function handleData(event) {
        const value = event.target.value;
        // 12バイト (float x 3) を読み取る
        const x = value.getFloat32(0, true);
        const y = value.getFloat32(4, true);
        const z = value.getFloat32(8, true);

        // 数値表示更新
        document.getElementById('values').textContent = 
            `X: ${x.toFixed(2)}, Y: ${y.toFixed(2)}, Z: ${z.toFixed(2)}`;

        // グラフ更新 (古いデータを削除して新しいデータを追加)
        chart.data.datasets.data.shift();
        chart.data.datasets.data.push(x);
        chart.data.datasets[2].data.shift();
        chart.data.datasets[2].data.push(y);
        chart.data.datasets[3].data.shift();
        chart.data.datasets[3].data.push(z);
        chart.update();
    }
</script>
</body>
</html>
