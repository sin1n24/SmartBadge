<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>XIAO Gyro Monitor (Safe Mode)</title>
    <!-- Chart.js v4.4.0 を指定して読み込みます（バージョン固定で安定化） -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <style>
        body { font-family: sans-serif; text-align: center; padding: 20px; background: #f5f5f5; }
        .container { max-width: 900px; margin: 0 auto; background: white; padding: 20px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); }
        .controls { margin: 20px 0; }
        button { padding: 10px 20px; margin: 0 5px; cursor: pointer; border: none; border-radius: 4px; color: white; font-size: 1em; }
        #btnConnect { background: #2196F3; }
        #btnRed { background: #F44336; }
        #btnBlue { background: #2196F3; }
        #btnOff { background: #9E9E9E; }
        button:disabled { background: #ddd; cursor: not-allowed; }
        #timer { font-size: 1.5em; font-weight: bold; color: #333; margin: 10px 0; }
        .values { display: flex; justify-content: space-around; margin-bottom: 10px; font-family: monospace; font-size: 1.2em; }
        
        /* エラー表示エリア */
        #error-log { color: red; background: #ffe6e6; padding: 10px; margin-top: 10px; border: 1px solid red; display: none; text-align: left; font-family: monospace; }
        #debug-log { text-align: left; font-family: monospace; font-size: 0.8em; color: #555; background: #eee; padding: 10px; margin-top: 20px; height: 100px; overflow-y: scroll; border: 1px solid #ccc; }
    </style>
</head>
<body>

<div class="container">
    <h2>XIAO ジャイロ グラフ (安全版)</h2>
    
    <div id="timer">00:00:00</div>
    
    <div class="controls">
        <button id="btnConnect">接続開始</button>
        <span style="margin-left: 20px;">LED操作: </span>
        <button id="btnRed" disabled>赤</button>
        <button id="btnBlue" disabled>青</button>
        <button id="btnOff" disabled>消灯</button>
    </div>

    <div class="values">
        <span style="color:rgb(255, 99, 132)">X: <span id="valX">0.00</span></span>
        <span style="color:rgb(54, 162, 235)">Y: <span id="valY">0.00</span></span>
        <span style="color:rgb(75, 192, 192)">Z: <span id="valZ">0.00</span></span>
    </div>

    <div id="error-log"></div>
    <canvas id="gyroChart"></canvas>
    <div id="debug-log">準備完了</div>
</div>

<script>
    const SERVICE_UUID   = '12345678-1234-5678-1234-56789abcdef0';
    const CHAR_GYRO_UUID = '12345678-1234-5678-1234-56789abcdef1';
    const CHAR_LED_UUID  = '12345678-1234-5678-1234-56789abcdef2';

    let ledCharacteristic;
    let startTime;
    let timerInterval;
    let chart; // グローバル変数として宣言

    // --- ログ関数 ---
    function log(msg) {
        const logBox = document.getElementById('debug-log');
        const ts = new Date().toLocaleTimeString();
        logBox.innerHTML = `[${ts}] ${msg}<br>` + logBox.innerHTML.slice(0, 2000);
        console.log(msg);
    }

    function logError(msg) {
        const errBox = document.getElementById('error-log');
        errBox.style.display = 'block';
        errBox.textContent = "【エラー発生】 " + msg;
        console.error(msg);
    }

    // --- グラフ初期化 ---
    function initChart() {
        const ctx = document.getElementById('gyroChart').getContext('2d');
        const maxPoints = 50; 
        
        // 配列を個別に作成して参照切れを防ぐ
        const dataX = new Array(maxPoints).fill(0);
        const dataY = new Array(maxPoints).fill(0);
        const dataZ = new Array(maxPoints).fill(0);
        const labels = new Array(maxPoints).fill('');

        chart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [
                    { label: 'X', data: dataX, borderColor: 'rgb(255, 99, 132)', borderWidth: 2, pointRadius: 0 },
                    { label: 'Y', data: dataY, borderColor: 'rgb(54, 162, 235)', borderWidth: 2, pointRadius: 0 },
                    { label: 'Z', data: dataZ, borderColor: 'rgb(75, 192, 192)', borderWidth: 2, pointRadius: 0 }
                ]
            },
            options: {
                responsive: true,
                animation: false, // 高速描画設定
                scales: {
                    y: { suggestedMin: -200, suggestedMax: 200 }
                }
            }
        });
        log("グラフ初期化完了");
    }

    // --- 接続処理 ---
    document.getElementById('btnConnect').addEventListener('click', async () => {
        try {
            // グラフが未作成なら作成
            if (!chart) initChart();

            const device = await navigator.bluetooth.requestDevice({
                filters: [{ namePrefix: "XIAO" }],
                optionalServices: [SERVICE_UUID]
            });

            log("デバイス選択: " + device.name);
            const server = await device.gatt.connect();
            const service = await server.getPrimaryService(SERVICE_UUID);
            
            ledCharacteristic = await service.getCharacteristic(CHAR_LED_UUID);
            const gyroChar = await service.getCharacteristic(CHAR_GYRO_UUID);
            
            await gyroChar.startNotifications();
            gyroChar.addEventListener('characteristicvaluechanged', handleGyroData);

            document.getElementById('btnConnect').disabled = true;
            document.getElementById('btnConnect').textContent = "接続済み";
            document.querySelectorAll('button:disabled').forEach(b => b.disabled = false);

            startTime = Date.now();
            timerInterval = setInterval(updateTimer, 100);
            log("通知受信開始...");

        } catch (e) {
            logError(e);
        }
    });

    // --- データ受信とグラフ更新 (Try-Catchで保護) ---
    function handleGyroData(event) {
        try {
            const value = event.target.value;
            const x = value.getFloat32(0, true);
            const y = value.getFloat32(4, true);
            const z = value.getFloat32(8, true);

            // 1. 数値表示
            document.getElementById('valX').textContent = x.toFixed(2);
            document.getElementById('valY').textContent = y.toFixed(2);
            document.getElementById('valZ').textContent = z.toFixed(2);

            // 2. グラフ更新 (安全な配列操作)
            if (chart && chart.data && chart.data.datasets.length >= 3) {
                // ラベル更新
                chart.data.labels.shift();
                chart.data.labels.push('');

                // データ更新: datasetがX, [1]がY, [2]がZ
                chart.data.datasets.data.shift();
                chart.data.datasets.data.push(x);

                chart.data.datasets[1].data.shift();
                chart.data.datasets[1].data.push(y);

                chart.data.datasets[2].data.shift();
                chart.data.datasets[2].data.push(z);

                // 再描画 (noneモードでちらつき防止)
                chart.update('none');
                
                // 成功ログ (頻度を落として表示)
                if (Math.random() < 0.05) {
                    log(`Data: ${x.toFixed(1)}, ${y.toFixed(1)}, ${z.toFixed(1)}`);
                }
            } else {
                throw new Error("チャートオブジェクトが不正です");
            }

        } catch (e) {
            // エラーがあってもここでキャッチして表示する
            logError("Update Error: " + e.message);
        }
    }

    function updateTimer() {
        const diff = Date.now() - startTime;
        const d = new Date(diff);
        const m = String(d.getUTCMinutes()).padStart(2, '0');
        const s = String(d.getUTCSeconds()).padStart(2, '0');
        const ms = String(Math.floor(d.getUTCMilliseconds()/100)).padStart(1, '0');
        document.getElementById('timer').textContent = `${m}:${s}.${ms}`;
    }

    async function sendLed(cmd) {
        if (ledCharacteristic) {
            try {
                await ledCharacteristic.writeValue(new Uint8Array([cmd]));
                log("LEDコマンド送信: " + cmd);
            } catch(e) { logError(e); }
        }
    }
    document.getElementById('btnRed').onclick = () => sendLed(1);
    document.getElementById('btnBlue').onclick = () => sendLed(2);
    document.getElementById('btnOff').onclick = () => sendLed(0);

    // 起動時にグラフ初期化を実行
    initChart();

</script>
</body>
</html>
